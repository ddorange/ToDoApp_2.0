(function(){    'use strict';    var    // Model    AppModel = Backbone.Model.extend({        defaults: {            state: ''        },        STATE: {            LIST: 'list',            DETAIL: 'detail'        },        initialize: function(){            this.beList();        },        beList: function(){            this.set('state', this.STATE.LIST);            this.changeState = this.beDetail;        },        beDetail: function(){            this.set('state', this.STATE.DETAIL);            this.changeState = this.beList;        }    }),    NoteModel = Backbone.Model.extend({        defaults: {            title: '',            content: ''        },        initialize: function(){            this.on('invalid', function(model, error){                alert(error);            });        },        validate: function(attrs){            if ( _.isEmpty(attrs.title) ) {                return 'Opps! Title is Empty!';            }            if ( _.isEmpty(attrs.content) ) {                return 'Opps! Content is Empty!';            }        }    }),    // Collection    NoteCollection = Backbone.Collection.extend({        model: NoteModel,        localStorage: new Backbone.LocalStorage('App')    }),    // View    AppView = Backbone.View.extend({        el: '#js-app',        CLAS: {            LIST: 'menu__list',            DETAIL: 'menu__detail'        },        events: {            'click .btn--return': '_back',            'click .btn--add':    '_addNew'        },        initialize: function() {            this.$menu = this.$('#js-menu_view');            this.model.on('change:state', this.render, this);        },        // TODO: ボタンの表示更新(いまのことろCSSで管理)        render: function() {            this.$menu.toggleClass(this.CLAS.LIST);            this.$menu.toggleClass(this.CLAS.DETAIL);            return this;        },        _addNew: function(){            // this.model.changeState();            Backbone.history.navigate('detail/new', {trigger: true});        },        _back: function(){            // this.model.changeState();            Backbone.history.navigate('', {trigger: true});        }    }),    ListView = Backbone.View.extend({        el: '#js-list_view',        initialize: function(){            this.listenTo(this.collection, 'add', this.addOne);                        this.collection.fetch();            this.render();        },        render: function() {            var fragmet = document.createDocumentFragment();            this.collection.each( function (_model) {                var noteView = new NoteView( {model: _model} );                fragmet.appendChild( noteView.render().el );            }, this);            this.el.appendChild(fragmet);            return this;        },    }),    NoteView = Backbone.View.extend({        tagName: 'li',        className: 'list__item',        template: _.template( $('#tmp-note').html() ),        events: {            'click': 'showDetail'        },        initialize: function() {            this.model.on('destroy', this.remove, this);            this.model.on('change', this.render, this);        },        render: function() {            var template = this.template( this.model.toJSON() );            this.$el.html(template);            return this;        },        showDetail: function(){            Backbone.history.navigate('detail/' + this.model.get('cid'), {trigger: true});        },        remove: function() {            this.$el.remove();        }    }),    DetailView = Backbone.View.extend({        el: '#js-detail_view',        title: '',        content: '',        initialize: function() {            this.$title = this.$('#js-detail_title');            this.$content = this.$('#js-detail_body');            this.listenTo(this.collection, 'ADD_NEW_NOTE', this.addNew);            this.listenTo(this.collection, 'OPEN_NOTE', this.openNote);        },        render: function(){            this.$title.val(this.title);            this.$content.val = (this.content);            this.$el.show();            return this;        },        addNew: function() {            console.log('addNew');            // this.collection.create();            this.render();        },        openNote: function(cid){            var model = this.collection.get(cid);            this.render();        },        destroy: function(){            console.log('DetailView_destroy');        },        back: function() {            var title = this.$el.find('#js-detail_title').val(),                body  = this.$el.find('#js-detail_body').val();            if ( this.model.set({title: title, body: body}, {validate: true}) ) {                this.$el.empty();            }        }    }),    AppRouter = Backbone.Router.extend({        routes: {            '': 'setList',            'detail/:id': 'setDetail'        },        setList: function(){            notes.trigger('SHOW_LIST');        },        setDetail: function(id){            if(id === 'new'){                console.log('create new note');                notes.trigger('ADD_NEW_NOTE');            } else {                console.log('open note:' + id);                notes.trigger('OPEN_NOTE', id);            }        }    }),    appModel = new AppModel(),    appRouter = new AppRouter(),    notes = new NoteCollection(),    menu = new AppView({ model: appModel }),    list = new ListView({ collection: notes }),    detail = new DetailView({ collection: notes });    Backbone.history.start();})();